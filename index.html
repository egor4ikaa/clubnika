<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üçì –ö–ª—É–±–Ω–∏—á–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</title>
  <link rel="stylesheet" href="style.css">
    
</head>
<body>
  <div class="brand-header">
    <h1>–ö–ª—É–±–Ω–∏—á–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</h1>
    <p>–û–ø—Ä–µ–¥–µ–ª–∏ —Å–æ—Ä—Ç –∫–ª—É–±–Ω–∏–∫–∏ –∑–∞ —Å–µ–∫—É–Ω–¥—É üçì</p>
  </div>

  <div class="container">
    <div id="webcam-container">
      <button id="start-webcam" class="btn">üì∏ –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
      <video id="webcam" autoplay playsinline muted class="hidden"></video>
      <button id="capture" class="btn hidden">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
    </div>

    <div id="upload-container">
      <p>–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ:</p>
      <label for="image-upload" class="upload-label">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
      <input type="file" id="image-upload" accept="image/*">
    </div>

    <div id="preview" class="hidden">
      <img id="uploaded-image" src="" alt="–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ">
    </div>

    <div id="prediction">–ó–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∫–ª—é—á–∏ –∫–∞–º–µ—Ä—É</div>
  </div>

  <!-- TensorFlow.js –∏ Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0"></script>

<script>
  const MODEL_URL = './model/model.json';
  const METADATA_URL = './model/metadata.json';

  let model = null;
  let classNames = [];

  async function initModel() {
    try {
      model = await tf.loadLayersModel(MODEL_URL);
      
      const response = await fetch(METADATA_URL);
      const metadata = await response.json();
      classNames = metadata.labels || metadata.words || ["–ö–ª–∞—Å—Å 1", "–ö–ª–∞—Å—Å 2"];

      document.getElementById('prediction').textContent = "–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ üçì";
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:", err);
      document.getElementById('prediction').innerHTML =
        '<strong>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏</strong><br>–ü—Ä–æ–≤–µ—Ä—å model.json –∏ weights.json';
    }
  }

  async function predict(imageElement) {
    if (!model) return;

    const tensor = tf.browser.fromPixels(imageElement)
      .resizeNearestNeighbor([224, 224])
      .toFloat()
      .div(255.0)
      .expandDims();

    const predictions = await model.predict(tensor).data();
    tensor.dispose();

    const result = [];
    for (let i = 0; i < classNames.length; i++) {
      result.push({
        className: classNames[i],
        probability: predictions[i]
      });
    }

    showResult(result);
  }

  function showResult(predictions) {
    let best = { className: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ", probability: 0 };
    for (let i = 0; i < predictions.length; i++) {
      if (predictions[i].probability > best.probability) {
        best = predictions[i];
      }
    }

    const percent = Math.round(best.probability * 100);
    const resultText = percent > 60
      ? `–°–æ—Ä—Ç: <strong>${best.className}</strong> (${percent}%)`
      : `–ù–µ —É–≤–µ—Ä–µ–Ω... –í–æ–∑–º–æ–∂–Ω–æ, <strong>${best.className}</strong> (${percent}%)`;

    document.getElementById('prediction').innerHTML = resultText;
  }

  document.getElementById('image-upload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const img = document.getElementById('uploaded-image');
    img.src = URL.createObjectURL(file);
    document.getElementById('preview').classList.remove('hidden');

    img.onload = () => predict(img);
  });

  let stream = null;

  document.getElementById('start-webcam').addEventListener('click', async () => {
    const video = document.getElementById('webcam');
    const captureBtn = document.getElementById('capture');

    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      video.srcObject = stream;
      video.classList.remove('hidden');
      captureBtn.classList.remove('hidden');
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
      document.getElementById('prediction').innerHTML =
        '<strong>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ</strong><br>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
    }
  });

  document.getElementById('capture').addEventListener('click', async () => {
    const video = document.getElementById('webcam');
    if (!video.srcObject) return;

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    predict(canvas);
  });

  window.addEventListener('beforeunload', () => {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
  });

  window.addEventListener('load', initModel);
</script>
